<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset='utf-8'/>
    <script defer th:inline="javascript" th:src="@{/index.global.js}" type="text/javascript"></script>
    <script defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5xt-0-bficSVL6EP57aQseXSiPx8bx7E&callback=initMap&libraries=&&libraries=geometry&libraries=places"></script>
    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
    <script src='https://code.jquery.com/ui/1.12.1/jquery-ui.js'></script>
    <!-- SweetAlert CDN 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>

        document.addEventListener('DOMContentLoaded', function () {

            var calendarEl = document.getElementById('calendar');
            var externalEventsListEl = document.getElementById('external-events-list');

            /* 관광지 목록을 저장할 변수 */
            const malls = [];
            const detailData = [];

            /*
            Controller -> Html -> Js 로 받아온 정보 (Html에서 Js로 받아올 경우 String으로 변환되어 온다.
            Controller에서 JSON형식으로 변환하여 전송해 JS에서 String으로 받아온 정보를 JSON타입으로 변환하여 사용한다.
            */

            // HTML로 부터 String 타입으로 데이터를 전달 받는다.
            var mallListData = document.getElementById('mallList').getAttribute('data-variable');
            var detailList = document.getElementById('detailList').getAttribute('data-variable');

            // JSON 타입으로 변환한다. (String의 형식이 JSON형식이여야지 가능하다.)
            var jsonObject = JSON.parse(mallListData);
            var jsonObject2 = JSON.parse(detailList);
            console.log(jsonObject2);

            // ForEach문을 사용해서 JS에서 사용할 수 있도록 변수에 저장한다.
            jsonObject.forEach(function (mall) {
                malls.push({
                    label: mall.touristAttractionId.toString(),     // 마커 중앙에 표시될 문자 (문자열로 받는거같은데 문자열로 변환을 해줘야 작동함)
                    name: mall.name,                                // 마커 클릭 시 표시되는 정보에 사용될 이름(관광지 이름)
                    lat: parseFloat(mall.latitude),                 // 위도 (실수 형태로 변환필요)
                    lng: parseFloat(mall.longitude),                // 경도 (실수 형태로 변환필요)
                    imageUrl: mall.image.toString(),                // 이미지 경로
                    address: mall.address.toString(),               // 주소
                    introduction: mall.introduction.toString()      // 소개글
                });
            });

            jsonObject2.forEach(function (detail) {
                detailData.push({
                    title: detail.content.toString(),
                    start: detail.startTime,
                    end: detail.endTime,
                    allDay: detail.allDay,
                });
            });


            /************************************************/
            /* Drag할 요소들을 리스트로 가져와 Drag 가능하도록 설정 */
            /************************************************/
            new FullCalendar.Draggable(externalEventsListEl, {
                itemSelector: '.fc-event',
                eventData: function (eventEl) {
                    return {
                        title: eventEl.querySelector('.fc-event-main').getAttribute('data-title'),
                        image: eventEl.querySelector('.fc-event-main').getAttribute('data-image')
                    }
                }
            });

            /****************/
            /* 초기 날짜 설정 */
            /****************/
            var today = new Date();

            /*************/
            /* 캘린더 설정 */
            /*************/
            var calendar = new FullCalendar.Calendar(calendarEl, {
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                initialDate: today,
                navLinks: true,
                selectable: true,
                selectMirror: true,
                select: function (arg) {
                    Swal.fire({
                        title: '일정 관리',
                        html: '<div id="image-preview"><img src="/pictures/base.jpg" style="width: 800px; height:800px;" onerror="this.src=\'/pictures/base.jpg\';"></div>' + getSelectOptions(malls) + '<input id="event-title" placeholder="계획을 입력하세요.">',
                        showCancelButton: true,
                        showCloseButton: true,
                        confirmButtonText: '추가',
                        cancelButtonText: '취소',
                        customClass: {
                            popup: 'custom-modal-width',        // 팝업창의 크기를 조절하기 위한 설정(HTML파일에서 Style설정도 해야함)
                        },
                        onBeforeOpen: () => {
                            const eventTypeSelect = document.getElementById('event-type');
                            const selectedImage = document.getElementById('selected-image');

                            eventTypeSelect.addEventListener('change', function () {
                                const selectedValue = eventTypeSelect.value;
                                const selectedMall = malls.find((mall) => mall.label === selectedValue);

                                if (selectedMall) {
                                    selectedImage.src = selectedMall.imageUrl;
                                } else {
                                    selectedImage.src = '/pictures/base.jpg'; // 선택된 이미지가 없을 경우 기본 이미지 표시
                                }
                            });
                        },
                        preConfirm: () => {
                            const eventTitle = document.getElementById('event-title').value;
                            const eventType = document.getElementById('event-type').value;
                            const selectedMall = malls.find((mall) => mall.label === eventType);

                            if (!eventTitle) {
                                Swal.showValidationMessage('계획 정보가 입력되지 않았습니다.');
                            } else {
                                calendar.addEvent({

                                    title: eventTitle,
                                    start: arg.start,
                                    end: arg.end,
                                    allDay: arg.allDay,
                                    id: generateEventId(),
                                    type: eventType ? eventType : '',
                                    image: selectedMall ? selectedMall.imageUrl : '',
                                });

                                // Controller에 데이터 전달
                                $.ajax({
                                    type: "POST",
                                    url: "/insertPlan",
                                    data: JSON.stringify({
                                        // detailPlanId     // insert에서 필요없을듯함
                                        touristAttractionId:1,  // 임시로 1로 지정
                                        content: eventTitle, // 내용
                                        startTime: arg.start,
                                        endTime: arg.end,
                                        allDay: arg.allDay,
                                        image: selectedMall ? selectedMall.imageUrl : ''
                                    }), // 데이터를 JSON 형식으로 보냄
                                    contentType: "application/json; charset=UTF-8",
                                    dataType: "text",
                                    success: function (response) {
                                        // 성공적으로 서버에 데이터를 전송한 후 실행할 코드
                                    },
                                    error: function () {
                                        // 오류 처리
                                    }
                                });


                            }
                        },
                    }).then((result) => {
                        calendar.unselect();
                    });

                    const imagePreview = document.getElementById('image-preview');
                    const eventTypeSelect = document.getElementById('event-type');

                    eventTypeSelect.addEventListener('change', function () {
                        const selectedValue = eventTypeSelect.value;
                        const selectedMall = malls.find((mall) => mall.label === selectedValue);

                        if (selectedMall) {
                            imagePreview.innerHTML = `<img src="${selectedMall.imageUrl}" alt="${selectedMall.name}"  style="width: 800px; height:800px;" onerror="this.src=\'/pictures/base.jpg\';"/>`;
                        } else {
                            imagePreview.innerHTML = `<img src="/pictures/base.jpg" style="width: 800px; height:800px;" onerror="this.src=\'/pictures/base.jpg\';"/>`;
                        }
                    });

                    function getSelectOptions(malls) {
                        let selectOptions = '<div><select id="event-type" class="swal2-select"><option value="">선택하지 않음</option>';
                        malls.forEach((mall) => {
                            selectOptions += `<option value="${mall.label}">${mall.name}</option>`;
                        });
                        selectOptions += '</select></div>';
                        return selectOptions;
                    }
                },
                eventClick: function (arg) {
                    var eventId = arg.event.id;
                    var eventImage = arg.event.extendedProps.image;
                    openDialog(eventId, arg.event.title, calendar, eventImage, arg);
                },
                editable: true,
                dayMaxEvents: true,
                initialView: 'timeGridWeek',        // 초기 달력 상태 (dayGridMonth,timeGridWeek,timeGridDay)
                events: detailData
            });

            calendar.render();

            /* 계획 생성 시 1씩 증가 */
            let currentEventId = 1;

            function generateEventId() {
                return String(currentEventId++);
            }

            /************************************************/
            /* 작성된 계획을 클릭하여 수정 또는 삭제 작업을 위한 함수 */
            /************************************************/
            function openDialog(eventId, eventTitle, calendar, eventImage, arg) {
                Swal.fire({
                    title: '일정 관리',
                    html: `
                            <div id="image-preview">
                                <img src="${eventImage}" alt="Selected Image" style="width: 800px; height: 800px;" onerror="this.src='/pictures/base.jpg';">
                            </div>
                            ${getSelectOptions(malls, eventTitle)}
                            <input id="event-title" class="swal2-input" value="${eventTitle}" placeholder="계획을 입력하세요."/>
                        `,
                    showCancelButton: true,
                    showDenyButton: true,
                    showCloseButton: true,
                    confirmButtonText: '수정',
                    denyButtonText: `삭제`,
                    cancelButtonText: '취소',
                    customClass: {
                        popup: 'custom-modal-width',
                    },
                    onBeforeOpen: () => {
                        const eventTypeSelect = document.getElementById('event-type');
                        const selectedImage = document.getElementById('selected-image');

                        eventTypeSelect.addEventListener('change', function () {
                            const selectedValue = eventTypeSelect.value;
                            const selectedMall = malls.find((mall) => mall.label === selectedValue);

                            if (selectedMall) {
                                selectedImage.src = selectedMall.imageUrl;
                            } else {
                                selectedImage.src = '/pictures/base.jpg'; // 선택된 이미지가 없을 경우 기본 이미지 표시
                            }
                        });
                    },
                    preConfirm: () => {
                        const newEventTitle = document.getElementById('event-title').value;
                        const selectedMallLabel = document.getElementById('event-type').value;
                        const selectedMall = malls.find((mall) => mall.label === selectedMallLabel);

                        if (!newEventTitle) {
                            Swal.showValidationMessage('계획 정보가 입력되지 않았습니다.');
                        } else {
                            // 수정된 이벤트 제목과 이미지를 적용
                            const event = calendar.getEventById(eventId);
                            event.setProp('title', newEventTitle);
                            event.setExtendedProp('image', selectedMall ? selectedMall.imageUrl : '');
                            calendar.refetchEvents();
                        }
                    },
                }).then((result) => {
                    if (result.isConfirmed) {
                        // 수정 버튼 클릭 시
                        // 수정 로직이 이미 preConfirm 함수에서 처리되었으므로 따로 처리할 내용은 없습니다.
                    } else if (result.dismiss === Swal.DismissReason.isDenied) {
                        // 삭제 버튼 클릭 시, 이벤트 삭제
                        const event = calendar.getEventById(eventId);
                        event.remove();
                    }
                });

                const imagePreview = document.getElementById('image-preview');
                const eventTypeSelect = document.getElementById('event-type');
                console.log(eventTypeSelect);

                eventTypeSelect.addEventListener('change', function () {
                    const selectedValue = eventTypeSelect.value;
                    const selectedMall = malls.find((mall) => mall.label === selectedValue);

                    if (selectedMall) {
                        imagePreview.innerHTML = `<img src="${selectedMall.imageUrl}" alt="${selectedMall.name}"  style="width: 800px; height:800px;" onerror="this.src='/pictures/base.jpg';"/>`;
                    } else {
                        imagePreview.innerHTML = `<img src="/pictures/base.jpg" style="width: 800px; height:800px;" onerror="this.src='/pictures/base.jpg';"/>`;
                    }
                });

                function getSelectOptions(malls, eventTitle) {
                    let selectOptions = '<div><select id="event-type" class="swal2-select"><option value="">선택하지 않음</option>';
                    malls.forEach((mall) => {
                        selectOptions += `<option value="${mall.label}"${eventTitle === mall.label ? ' selected' : ''}>${mall.name}</option>`;
                    });
                    selectOptions += '</select></div>';
                    return selectOptions;
                }
            }


        });

    </script>



    <script>
        <!-- 관광지를 도시별로 검색 -->
        document.addEventListener("DOMContentLoaded", function () {
            var searchSelect = document.getElementById("searchSelect");
            var searchButton = document.getElementById("searchButton2");
            var externalEventsList = document.getElementById("external-events-list");

            searchButton.addEventListener("click", function () {
                var selectedKeyword = searchSelect.value; // 선택된 검색어 가져오기

                // 서버로 선택된 검색어를 전송하고 결과를 받아올 수 있는 AJAX 요청 보내기
                $.ajax({
                    url: '/selectAttraction?keyword=' + selectedKeyword, // 서버의 URL
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        // 받아온 JSON 데이터를 사용하여 external-events 업데이트
                        externalEventsList.innerHTML = ""; // 기존 목록 비우기

                        for (var i = 0; i < data.length; i++) {
                            var attraction = data[i];
                            // external-events를 업데이트하는 로직을 작성
                            var eventHtml = '<div class="fc-event" data-image="' + attraction.image + '" ' +
                                'data-title="' + attraction.name + '">' +
                                '<img style="width:200px; height:200px;" src="' + attraction.image + '">' +
                                '<div style="text-align: center;">' + attraction.name + '</div>' +
                                '</div>';

                            var draggableEl = document.createElement('div');
                            draggableEl.innerHTML = eventHtml;
                            externalEventsList.appendChild(draggableEl);

                            // 드래그 가능한 외부 이벤트로 만들기
                            new FullCalendar.Draggable(draggableEl, {
                                eventData: {
                                    title: attraction.name,
                                    image: attraction.image
                                }
                            });
                        }
                    },
                    error: function () {
                        console.error('데이터를 가져오는 중에 오류가 발생했습니다.');
                    }
                });
            });

            // 페이지 로딩 후 검색 버튼을 자동으로 클릭
            searchButton.click();
        });
    </script>




    <style>
        /* SweetAlert창 크기 */
        .custom-modal-width {
            width: 1000px;
        }

        body {
            margin: 40px 10px;
            padding: 0;
            font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
            font-size: 14px;
        }

        #external-events h4 {
            font-size: 16px;
            margin-top: 0;
            padding-top: 1em;
        }

        #external-events .fc-event {
            margin: 3px 0;
            cursor: move;
        }

        #calendar {

            width: 500px;
            height: 500px;
            margin: 0 auto;
        }

        .contain {
            display: flex;
            margin: 100px;
        }

        #map {
            flex: 1;
            width: 500px;
            height: 500px;
        }

        #calendar-wrap {
            flex: 1;
        }

        #searchResults {
            background-color: rgba(255, 255, 255, 0.9); /* 흰 배경색 및 투명도 설정 */
            border: 1px solid #ccc; /* 테두리 설정 */
            border-radius: 5px; /* 둥근 테두리 설정 */
            padding: 10px; /* 내부 여백 설정 */
            max-height: 300px; /* 최대 높이 설정 (내용이 너무 길 경우 스크롤 표시) */
            overflow-y: auto; /* 세로 스크롤바 표시 (내용이 길 경우) */
        }

        /* 알림창 내용 input 태그  */
        #event-title {
            width: 80%;
            padding: 5px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<div id="mallList" th:data-variable="${touristAttractionListJson}"></div>
<div id="detailList" th:data-variable="${detailPlan}"></div>






<div class="contain" style="display: flex;">
    <div id="map-container" style="position: relative;">
        <!-- 검색창 -->
        <input id="searchInput" placeholder="장소 검색" style="position: absolute; top: 10px; left: 10px; z-index: 1;"
               type="text">
        <button id="searchButton" style="position: absolute; top: 10px; left: 190px; z-index: 1;">검색</button>
        <button id="cancelButton" style="position: absolute; top: 10px; left: 240px; z-index: 1; display: none;">검색 취소
        </button>
        <ul id="searchResults" style="position: absolute; top: 50px; left: 10px; z-index: 1; display: none;"></ul>
        <!-- 지도 -->
        <div id="map"></div>
    </div>

    <div id='calendar-wrap'>
        <div id='calendar'></div>
    </div>
</div>

<select id="searchSelect">
    <option value="">전체</option>
    <option value="파리">파리</option>
    <option value="보르도">보르도</option>
    <option value="마르세유">마르세유</option>
</select>

<button id="searchButton2">Search</button>

<div id="searchResult"></div>

<div id='wrap'>
    <div id='external-events'>
        <div id='external-events-list' style="display: flex; flex-direction: row; overflow-x: auto;">

        </div>
    </div>
</div>


</body>
</html>
