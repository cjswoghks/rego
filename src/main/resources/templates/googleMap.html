<!DOCTYPE html>
<html  xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset='utf-8' />
    <script defer th:inline="javascript" th:src="@{/index.global.js}" type="text/javascript"></script>
    <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5xt-0-bficSVL6EP57aQseXSiPx8bx7E&callback=initMap&libraries=&&libraries=geometry&libraries=places"></script>
    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
    <script src='https://code.jquery.com/ui/1.12.1/jquery-ui.js'></script>
    <!-- SweetAlert CDN 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>

        document.addEventListener('DOMContentLoaded', function() {
          var calendarEl = document.getElementById('calendar');
          var externalEventsListEl = document.getElementById('external-events-list');

          // Drag할 요소들을 리스트로 가져와 Drag 가능하도록 설정
          new FullCalendar.Draggable(externalEventsListEl, {
            itemSelector: '.fc-event',
            eventData: function(eventEl) {
              return {
                title: eventEl.querySelector('.fc-event-main').getAttribute('data-title'),
                image: eventEl.querySelector('.fc-event-main').getAttribute('data-image')
              }
            }
          });

          var today = new Date();
          var calendar = new FullCalendar.Calendar(calendarEl, {
            headerToolbar: {
              left: 'prev,next today',
              center: 'title',
              right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            initialDate: today,
            navLinks: true,
            selectable: true,
            selectMirror: true,
            select: function(arg) {
              Swal.fire({
                title: 'Event Title:',
                input: 'text',
                showCancelButton: true,
                confirmButtonText: 'Add Event',
                cancelButtonText: 'Cancel',
                inputValidator: (value) => {
                  if (!value) {
                    return 'Event title is required';
                  } else {
                    calendar.addEvent({
                      title: value,
                      start: arg.start,
                      end: arg.end,
                      allDay: arg.allDay,
                      id: generateEventId()
                    });
                  }
                }
              }).then((result) => {
                calendar.unselect();
              });
            },
            eventClick: function(arg) {
              var eventId = arg.event.id;
              var eventImage = arg.event.extendedProps.image;
              openDialog(eventId, arg.event.title, calendar, eventImage);
            },
            editable: true,
            dayMaxEvents: true,
            defaultView: 'timeGridWeek',
            events: [
            ]
          });

          calendar.render();

          /* 계획 생성 시 1씩 증가 */
          let currentEventId = 1;

          function generateEventId() {
            return String(currentEventId++);
          }

        });

        /* 작성된 계획을 클릭하여 수정 또는 삭제 작업을 위한 함수 */
        function openDialog(eventId, eventTitle, calendar, eventImage) {
          const hasImage = eventImage; // 이미지가 있는지 여부를 체크


          if (hasImage){
            Swal.fire({
              title: '이 정보는 수정이 불가능합니다.',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              imageUrl: eventImage, // 이미지가 있을 경우에만 이미지를 표시합니다.
              cancelButtonColor: '#d33',
              cancelButtonText: 'Delete',
              showCloseButton: true,
            }).then((result) => {
              if (result.dismiss === Swal.DismissReason.cancel) {
                // 삭제 버튼 클릭 시, 이벤트 삭제
                var event = calendar.getEventById(eventId);
                event.remove();
              }
            });
          } else {
            Swal.fire({
              title: '수정 또는 삭제',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Edit',
              cancelButtonText: 'Delete',
              showCloseButton: true,
            }).then((result) => {
              if (result.isConfirmed) {
                // 수정 버튼이 보이는 경우에만 아래 로직을 실행합니다.
                Swal.fire({
                  title: 'Edit Event',
                  input: 'text',
                  inputValue: eventTitle,
                  showCancelButton: true,
                  confirmButtonText: 'Save',
                  cancelButtonText: 'Cancel',
                  inputValidator: (value) => {
                    if (!value) {
                      return 'Event title is required';
                    } else {
                      // 수정된 이벤트 제목을 적용
                      var event = calendar.getEventById(eventId);
                      event.setProp('title', value);
                      calendar.refetchEvents();
                    }
                  }
                });
              } else if (result.dismiss === Swal.DismissReason.cancel) {
                // 삭제 버튼 클릭 시, 이벤트 삭제
                var event = calendar.getEventById(eventId);
                event.remove();
              }
            });
          }
        }




    </script>
    <style>
        /* SweetAlert창 크기 */
        .custom-modal-width {
            width: 1000px;
        }

        body {
          margin: 40px 10px;
          padding: 0;
          font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
          font-size: 14px;
        }

        #external-events h4 {
          font-size: 16px;
          margin-top: 0;
          padding-top: 1em;
        }

        #external-events .fc-event {
          margin: 3px 0;
          cursor: move;
        }

        #calendar {
          max-width: 1000px;
          margin: 0 auto;
        }

        .contain{
            display:flex;
            margin:100px;
        }

        #map{
            flex:1;
            width: 800px;
            height: 800px;
        }

        #calendar-wrap{
            flex:1;
        }

        #searchResults {
            background-color: rgba(255, 255, 255, 0.9); /* 흰 배경색 및 투명도 설정 */
            border: 1px solid #ccc; /* 테두리 설정 */
            border-radius: 5px; /* 둥근 테두리 설정 */
            padding: 10px; /* 내부 여백 설정 */
            max-height: 300px; /* 최대 높이 설정 (내용이 너무 길 경우 스크롤 표시) */
            overflow-y: auto; /* 세로 스크롤바 표시 (내용이 길 경우) */
        }
    </style>
</head>
<body>

<div id="mallList" th:data-variable="${mallList}"></div>


<div class="contain" style="display: flex;">
    <div id="map-container" style="position: relative;">
        <!-- 검색창 -->
        <input id="searchInput" placeholder="장소 검색" style="position: absolute; top: 10px; left: 10px; z-index: 1;" type="text">
        <button id="searchButton" style="position: absolute; top: 10px; left: 190px; z-index: 1;">검색</button>
        <button id="cancelButton" style="position: absolute; top: 10px; left: 240px; z-index: 1; display: none;">검색 취소</button>
        <ul id="searchResults" style="position: absolute; top: 50px; left: 10px; z-index: 1; display: none;"></ul>
        <!-- 지도 -->
        <div id="map"></div>
    </div>

    <div id='calendar-wrap'>
        <div id='calendar'></div>
    </div>
</div>

<div id='wrap'>
    <div id='external-events' >
        <h4>Draggable Events</h4>
        <div id='external-events-list' style="display: flex; flex-direction: row; overflow-x: auto;">
            <div class='fc-event'  th:each="touristAttraction : ${touristAttractionList}">
                <div class='fc-event-main' th:data-image="${touristAttraction.image}" th:data-title="${touristAttraction.name}"><img style="width:200px; height:200px;" th:src="${touristAttraction.image}"><div style="text-align: center;" th:text="${touristAttraction.name}"></div></div>
            </div>
        </div>

        <p>
            <input id='drop-remove' type='checkbox' />
            <label for='drop-remove'>remove after drop</label>
        </p>
</div>
</div>


</body>
</html>
